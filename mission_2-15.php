<html>
<head>好きな曲を書いてください</head><br/> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />

<?php //password判定
    if(!empty($_POST['key'])){
	$key = $_POST['key'];
	if(!empty($_POST['number'])){
		$id = $_POST['number'];
	}else if(!empty($_POST['delete'])){
		$id = $_POST['delete'];
	}
			$dsn = '********';
			$user = '*********';
			$password = '********';
	
			try {
		//データベースに接続
		$pdo = new PDO($dsn,$user,$password);
			//echo "接続完了<br>";
		//tbtestの全カラム(列)を取り出す
		$sql = "SELECT * FROM keiji WHERE id = ?";
		$stmt = $pdo->prepare($sql);
		$stmt->bindValue(1, $id, PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		//print_r($result);
		$password = $result[password];
		if($password === $key){
			$match = "match";
			//echo "$match";
		}else if($password != $key){
			echo "パスワードが一致しません";
		}
			$pdo = null;
			}catch (Exception $e) {
			 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
			 die();
		
		}
	}else if(empty($_POST['key']) && (!empty($_POST['number']) or !empty($_POST['delete']) )){
		echo "パスワードを入力してください1";
}
?>
<?php  //名前とコメントを保存する
	//更新した際などに実行されないように条件分岐させる
	if(!empty($_POST['name']) && !empty($_POST['comment']) && empty($_POST['edit']) && !empty($_POST['password'])){
				//echo "f1に入れている";
				$f1 = $_POST['name'];
				$f2 = $_POST['comment'];
				//時間の取得
				date_default_timezone_set('Asia/Tokyo');//世界基準表示から東京表示に直す
				$time = date("Y/m/d H:i:s",time());
				$pass = $_POST['password'];
				
				$dsn = '********';
			$user = '*********';
			$password = '********';
				
				try {
				//データベースに接続
				$pdo = new PDO($dsn,$user,$password);
					//echo "接続完了";
				//設定したSQLをPDOで利用できるように入力(SQL命令)
				$sql = $pdo -> prepare("INSERT INTO keiji (name, comment,time,password) VALUES (:name, :comment, :time, :password)");
	
				//指定された変数にパラメーターを紐づける
				$sql -> bindParam(':name', $name, PDO::PARAM_STR);
				$sql -> bindParam(':comment', $comment, PDO::PARAM_STR);  
				$sql -> bindParam(':time', $time1, PDO::PARAM_STR);
				$sql -> bindParam(':password', $pass, PDO::PARAM_STR);  


			$name = "$f1";
			$comment = "$f2";
			$time1 = "$time";
			$pass = "$pass";
			
			//指定したSQLを実行する
			$sql -> execute();
				
				$pdo = null;
				}catch (Exception $e) {
					 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
					 die();

}
     		}else if(!empty($_POST['name']) && !empty($_POST['comment']) && empty($_POST['password'])){
     			echo "パスワードを入力してください";
     		}
?>


<?php  //削除する
	//echo "$match";
	//入力があった場合のみ
	if(!empty($_POST['delete'])&& !empty($match)){
			$id =(int)$_POST['delete'];
			$password = $_POST['password'];

			$dsn = '********';
			$user = '*********';
			$password = '********';

				try{
				//データベースに接続
				$pdo = new PDO($dsn,$user,$password);
				
				//プレースホルダを指定してDELETEのSQLを入力
				$sql = "DELETE FROM keiji WHERE id= ?";  
				//SQLを実行する準備を入力
				$stmt = $pdo->prepare($sql);
				$stmt->bindValue(1, $id, PDO::PARAM_INT);
				$stmt->execute();
				
				
				
				$sql = "ALTER TABLE keiji DROP COLUMN id";
				$stmt = $pdo -> query($sql);
				$sql = "ALTER TABLE keiji ADD id INT(11) PRIMARY KEY AUTO_INCREMENT FIRST";
				$stmt = $pdo -> query($sql);
				$pdo = null;
				
				echo "ID:" . htmlspecialchars($id, ENT_QUOTES, 'UTF-8') . "の削除が完了しました";
				
					}catch (Exception $e) {
					 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
					 die();

						}

				
  		}	
?>


<?php //編集番号で指定された名前とコメントを取得
	if(!empty($_POST['number']) && !empty($match) ){
		$id =(int)$_POST['number'];
		$password = $_POST['key'];
		
			$dsn = '********';
			$user = '*********';
			$password = '********';
		
		try {
		//データベースに接続
		$pdo = new PDO($dsn,$user,$password);
			//echo "接続完了<br>";
		//tbtestの全カラム(列)を取り出す
		$sql = "SELECT * FROM keiji WHERE id = ?";
		$stmt = $pdo->prepare($sql);
		$stmt->bindValue(1, $id, PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		//print_r($result);
		$data1 = $result[name];
		$data2 = $result[comment];
		$key_re =  $result[password];
		$edit_num = $id;
			$pdo = null;
			}catch (Exception $e) {
			 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
			 die();
		
		}
		
	}
?>


<?php    //編集する名前とコメントを保存
	//echo $_POST['edit'];
	if(!empty($_POST['edit']) ){
		//echo "編集モードになっている";
		$name = $_POST['name'];
		$comment = $_POST['comment'];
		$id=$_POST['edit'];
	
						
			$dsn = '********';
			$user = '*********';
			$password = '********';
				
				try {
				//データベースに接続
				$pdo = new PDO($dsn,$user,$password);
					//echo "接続完了";
				$sql = "UPDATE keiji SET name = ?, comment = ? WHERE id = ?";
				$stmt = $pdo->prepare($sql);
				$stmt->bindValue(1,$name, PDO::PARAM_STR);
				$stmt->bindValue(2,$comment,PDO::PARAM_STR);
				$stmt->bindValue(3,$id, PDO::PARAM_INT);
				//指定したSQLを実行する
				$stmt -> execute();
				
				$pdo = null;
				}catch (Exception $e) {
					 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
					 die();
				}

	}
	

?>

<?php  //表示させるプログラム

$dsn = '********';
$user = '*********';
$password = '********';

try {
//データベースに接続
$pdo = new PDO($dsn,$user,$password);
	//echo "接続完了<br>";
//tbtestの全カラム(列)を取り出す
$sql = 'SELECT * FROM keiji';
$results = $pdo -> query($sql);
foreach ($results as $row){
    //$rowの中にはテーブルのカラム名が入る
    echo $row['id'].'.';
    echo $row['name'].'<br>';
    echo $row['comment'].'<br>';
    echo $row['time'].'<br>';
    echo '<br>';
	}
	$pdo = null;
}catch (Exception $e) {
	 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
	 die();

}
?>
<hr>
<body>
<title>エフェクターブログ</title>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
	<form  action="mission_2_15.php" method = "post">
	<head>名前</head><br/>
	<input type="text" name="name" value = "<?php echo $data1; ?>"><br/>

	<head>コメント</head><br/>
	<textarea name = "comment" cols = "40" rows = "4" maxlength="120"><?php echo $data2; ?></textarea><br/>
	<input type = "hidden" name = "edit" value = "<?php echo $edit_num; ?>">
	<input type="hidden" name="number1" value = "<?php echo $f4; ?>" >
	
	<head>パスワード</head><br/>
	<input type="text" name="password" value ="<?php echo $key_re; ?>" ><br/>
	<input type="submit" value="送信"><br/>
	</form>

	<form  action="mission_2_15.php" method = "post">
	<head>削除対象番号</head><br/>
	<input type="text" name="delete"><br/>
	<head>パスワード</head><br/>
	<input type="text" name="key"><br/>
	<input type="submit" value="削除"><br/>
	</form>

	<form  action="mission_2_15.php" method = "post">
	<head>編集対象番号</head><br/>
	<input type="text" name="number"><br/>
	<head>パスワード</head><br/>
	<input type="text" name="key"><br/>
	<input type="submit" value="編集番号指定"><br/>
	</form>
</body>
</body>
</html>